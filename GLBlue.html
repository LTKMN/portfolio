<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLB to Bluesky Converter</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.161.0/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/examples/js/exporters/GLTFExporter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/examples/js/utils/BufferGeometryUtils.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;

        function App() {
            const [file, setFile] = useState(null);
            const [result, setResult] = useState(null);
            const [copied, setCopied] = useState(false);
            const [processing, setProcessing] = useState(false);

            const optimizeGeometry = (geometry) => {
                // Convert to non-indexed if it isn't already
                let nonIndexed = geometry.index !== null ? 
                    geometry.toNonIndexed() : 
                    geometry.clone();

                // Merge vertices that are very close to each other
                nonIndexed = THREE.BufferGeometryUtils.mergeVertices(nonIndexed, 0.001);

                // Optimize normal and position precision
                const positions = nonIndexed.attributes.position.array;
                const normals = nonIndexed.attributes.normal?.array;

                // Quantize positions to 16-bit
                const quantizedPositions = new Uint16Array(positions.length);
                for (let i = 0; i < positions.length; i++) {
                    quantizedPositions[i] = Math.round((positions[i] + 1) * 32767);
                }
                nonIndexed.setAttribute('position', new THREE.Uint16BufferAttribute(quantizedPositions, 3));

                // Quantize normals to 8-bit
                if (normals) {
                    const quantizedNormals = new Uint8Array(normals.length);
                    for (let i = 0; i < normals.length; i++) {
                        quantizedNormals[i] = Math.round((normals[i] * 0.5 + 0.5) * 255);
                    }
                    nonIndexed.setAttribute('normal', new THREE.Uint8BufferAttribute(quantizedNormals, 3));
                }

                return nonIndexed;
            };

            const processFile = async () => {
                if (!file) return;
                
                setProcessing(true);
                
                try {
                    const buffer = await file.arrayBuffer();
                    const originalSize = buffer.byteLength;

                    // Load the GLB
                    const loader = new THREE.GLTFLoader();
                    const gltf = await new Promise((resolve, reject) => {
                        loader.parse(buffer, '', resolve, reject);
                    });

                    // Get the first mesh and optimize its geometry
                    const mesh = gltf.scenes[0].children[0];
                    const optimizedGeometry = optimizeGeometry(mesh.geometry);

                    // Create new mesh with optimized geometry
                    const optimizedMesh = new THREE.Mesh(optimizedGeometry, mesh.material);
                    const scene = new THREE.Scene();
                    scene.add(optimizedMesh);

                    // Export back to GLB
                    const exporter = new THREE.GLTFExporter();
                    const optimizedGLB = await new Promise((resolve) => {
                        exporter.parse(scene, resolve, { 
                            binary: true,
                            includeCustomExtensions: false,
                            embedImages: false
                        });
                    });

                    // Convert to base64
                    const base64 = btoa(String.fromCharCode(...new Uint8Array(optimizedGLB)));
                    const compressedBase64 = base64.replace(/[+/]|=+$/g, '');
                    
                    const stats = {
                        originalSize,
                        compressedSize: optimizedGLB.byteLength,
                        encodedLength: compressedBase64.length,
                        willFit: compressedBase64.length <= 2000,
                        compressionRatio: ((optimizedGLB.byteLength / originalSize) * 100).toFixed(1)
                    };
                    
                    setResult({
                        altText: `GLB1|${compressedBase64}`,
                        stats
                    });
                } catch (error) {
                    console.error('Processing failed:', error);
                } finally {
                    setProcessing(false);
                }
            };

            const handleFile = async (event) => {
                event.preventDefault();
                const newFile = event.target.files?.[0] || event.dataTransfer?.files?.[0];
                if (!newFile || !newFile.name.toLowerCase().endsWith('.glb')) return;
                setFile(newFile);
                setResult(null);
            };

            const copyToClipboard = async () => {
                if (result?.altText) {
                    await navigator.clipboard.writeText(result.altText);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                }
            };

            return (
                <div className="max-w-2xl mx-auto p-6">
                    <h1 className="text-2xl font-bold mb-4">GLB to Bluesky Converter</h1>
                    
                    {/* Upload */}
                    <div 
                        className="border-2 border-dashed rounded-lg p-8 text-center mb-6"
                        onDragOver={(e) => e.preventDefault()}
                        onDrop={(e) => {
                            e.preventDefault();
                            handleFile(e);
                        }}
                    >
                        <input
                            type="file"
                            accept=".glb"
                            onChange={handleFile}
                            className="hidden"
                            id="file-upload"
                        />
                        <label htmlFor="file-upload" className="cursor-pointer">
                            <div className="text-4xl mb-2">⬆️</div>
                            <div className="text-sm text-gray-600">
                                Drop GLB file here or click to upload
                            </div>
                            {file && (
                                <div className="mt-2 text-sm text-gray-500">
                                    Selected: {file.name}
                                </div>
                            )}
                        </label>
                    </div>

                    {/* Process Button */}
                    {file && !processing && !result && (
                        <button
                            onClick={processFile}
                            className="w-full py-2 px-4 bg-blue-500 text-white rounded hover:bg-blue-600 mb-6"
                        >
                            Process GLB
                        </button>
                    )}

                    {/* Processing State */}
                    {processing && (
                        <div className="text-center py-4 text-gray-600">
                            Processing file...
                        </div>
                    )}

                    {/* Results */}
                    {result && (
                        <div className="space-y-4">
                            {/* Stats */}
                            <div className="bg-gray-50 p-4 rounded-lg">
                                <div>Original size: {(result.stats.originalSize / 1024).toFixed(2)} KB</div>
                                <div>Compressed size: {(result.stats.compressedSize / 1024).toFixed(2)} KB</div>
                                <div>Compression ratio: {result.stats.compressionRatio}%</div>
                                <div>Encoded length: {result.stats.encodedLength} characters</div>
                                <div className={result.stats.willFit ? "text-green-600" : "text-red-600"}>
                                    {result.stats.willFit ? "Will fit in alt text" : "Too large for alt text"}
                                </div>
                            </div>

                            {/* Alt Text */}
                            {result.stats.willFit && (
                                <div className="border rounded-lg p-4">
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="font-medium">Encoded Alt Text</div>
                                        <button
                                            onClick={copyToClipboard}
                                            className="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"
                                        >
                                            {copied ? '✓ Copied!' : 'Copy'}
                                        </button>
                                    </div>
                                    <div className="text-sm text-gray-600 break-all">
                                        {result.altText.slice(0, 100)}...
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Reset Button */}
                    {result && (
                        <button
                            onClick={() => {
                                setFile(null);
                                setResult(null);
                            }}
                            className="mt-4 w-full py-2 px-4 border border-gray-300 rounded hover:bg-gray-50"
                        >
                            Process Another File
                        </button>
                    )}

                    <div className="mt-8 text-sm text-gray-600">
                        <p className="mb-2">Instructions:</p>
                        <ol className="list-decimal pl-5">
                            <li>Upload a GLB file</li>
                            <li>Click "Process GLB"</li>
                            <li>Copy the encoded alt text (if it fits)</li>
                            <li>Create a new Bluesky post with an image</li>
                            <li>Paste the encoded text as the image's alt text</li>
                        </ol>
                    </div>
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
